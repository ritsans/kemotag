# 仕様書（MVP） KEMOTAG

**※開発途中で変更されることがあります。**

## 1. 定義

Kemotagは、同人イベント・オフ会などで会った相手と「公開プロフィール（デジタル名刺）」を交換し、閲覧者がスマートフォンから素早くSNS（主にX）へ遷移できるWebアプリである。作る側（プロフィール所有者）はログイン必須とし、デジタル名刺ページは基本公開とする。閲覧者が非ログインでも、閲覧した相手の履歴とお気に入りを端末（IndexedDB）に残せる。

---

## 2. 目的（MVPのゴール）

1. 作る側がログイン。自分の公開プロフィール（名刺）を作成、URL/QRで共有できる。
2. 見る側が公開プロフィールにアクセスすると、ハンドルネーム・アバター・Xリンクを確認でき、XやPixivへワンタップで遷移できる。

ここまででフロントエンドの基本を完成させる。
この基本機能をベースにアプリ独自の機能を付け加えていく。

3. 見る側（非ログインユーザー）が、閲覧履歴を自動記録し、必要ならお気に入り（ピン留め）で明示的に保存できる。
4. ログイン済み閲覧者は、お気に入りのみクラウドDBに同期できる（論理削除方式）。

---

## 3. 用語

* `user_id`：認証基盤が発行するログインユーザーの一意ID（行動主体）。公開しない。
* `profile_id`：公開プロフィール（名刺ページ）の一意ID。公開URLに使用する。推測困難なランダムIDとする。
* `owner_user_id`：profilesテーブルで、そのプロフィールを管理する`user_id`。
* 閲覧履歴：公開プロフィールを開いた事実を端末に自動保存したもの。クラウド同期しない。
* お気に入り：他者のプロフィールページのURLを保存したもの。後で見返すための機能。端末に保存し、ログイン時のみクラウド同期する。
* X(x) : SNSである旧Twitterの現在の名称。通称エックス。tweet等の言葉はpostに変わっている。

---

## 4. ユーザー種別と権限

### 4.1 作る側（プロフィール所有者）

* ログイン必須
* 自分のプロフィールを作成・編集できる
* 編集したプロフィールはDBに保存される。
* お気に入りは端末・DBの両方に保存される。

### 4.2 見る側（閲覧者）

* 非ログインでも他社のプロフィールを閲覧できる
* 閲覧履歴は自動で端末保存される
* お気に入りは端末保存できる
* ログインしている場合のみ、お気に入りをクラウドDB同期できる

---

## 5. URL設計

* 公開プロフィール：`/p/{profile_id}`
  理由：公開ページであることを明示し、内部画面と分離。QR共有かつ将来拡張に強い。

---

## 6. 公開プロフィール（名刺ページ）の要件（スマホ最優先）

### 6.1 表示要件（ファーストビュー優先）

プロフィールへアクセス直後に以下を最優先で表示する。

* `display_name`（ハンドルネーム）
* `avatar`（アバター）
* Xへのリンク（最優先の大きなボタン）

DiscordやPixivアカウントなど追加リンク機能はMVPでは後回しにできる（設計上は拡張可能にする）。

### 6.2 必須データ項目

* `display_name`：必須
* `avatar`：必須（未設定時はプレースホルダー表示を許容し、プロフィール完成までに設定を促す）
* `x_username`：必須（URLまたはusername入力を受け付け、保存はusernameに正規化する方針）

---

## 7. 端末保存（IndexedDB）

### 7.1 閲覧履歴（自動記録）

* 公開プロフィール閲覧時に自動記録する
* 常に端末（IndexedDB）のみ。クラウド同期しない
* 上限は300件。到達時にはこれ以上保存できない旨のメッセージを出す。勝手に削除しない。
* 保存方式：`profile_id`を主キーにupsertし、`last_viewed_at`を更新する
* 上限超過時：古いものから削除する

端末に保持する最小データは次の通り。

* `profile_id`
* `display_name`
* （推奨）`x_username`（一覧から即Xへ遷移するため）

### 7.2 お気に入り（ピン留め）

* ユーザー操作で保存/解除できる
* 端末（IndexedDB）には常に保存する
* 削除は論理削除（`deleted_at`）
* MVPでは期限削除は行わない

---

## 8. クラウド同期（ログイン時のみ）

### 8.1 同期対象

* 同期するのは「お気に入り」のみ
* 保存対象は `profile_id` の参照のみ（プロフィール情報を複製しない）

### 8.2 同期タイミング（シンプル実装）

* ログイン中の保存/解除は楽観的更新で即UI反映し、クラウドへ反映を試みる
* 非ログイン時に溜まったお気に入りは、ログイン直後に一括取り込み（同期）できる

### 8.3 削除方式

* クラウド側も論理削除（`deleted_at`）
* 有効データは `deleted_at is null` のみ

---

## 9. プロフィール作成（登録時の定義）

* 登録/初回ログインで `user_id` が確定する
* 初回ログイン時に `profiles` を自動作成する（推奨）
* `profile_id` は推測困難なランダムIDで生成し、公開URLに使う
* `profiles.owner_user_id = user_id` を必ず設定する
* プロフィールが未完成（x_username未設定等）の場合は、編集画面で入力を促し、公開プロフィールとして成立するまで誘導する

* profile_idの自動生成ルール: base62 のランダム15文字。

  - 英数字 (可能なら大小+数字)

  - 生成は暗号学的に安全な乱数を使う（Math.random不可）

  - DB側で profile_id にユニーク制約（衝突時は再生成）

---

## 10. データモデル（概念）

### 10.1 クラウドDB

* `profiles(profile_id, owner_user_id, display_name, avatar_url, x_username, created_at, updated_at)`
* `bookmarks(user_id, profile_id, deleted_at, created_at, updated_at)`

  * 一意制約：`(user_id, profile_id)`

### 10.2 端末DB（IndexedDB）

* `view_history(profile_id, last_viewed_at, display_name, x_username)`
* `saved_local(profile_id, deleted_at, updated_at, [sync_state])`

---

## 11. スコープ外（MVPでは実装しない）

* 会場モード（軽量ルーティング・PWA最適化等）
* お気に入りの期限削除
* Discord等の追加リンクの本格実装（後回し可）
* 相互交換・承認・フォロー自動化
* 閲覧履歴のクラウド同期

---

## 12. 受け入れ条件（Acceptance Criteria）

1. ログインした作る側がプロフィールを作成・編集できる
2. 公開プロフィール `/p/{profile_id}` が非ログインでも表示できる
3. 公開プロフィールにアクセスした直後に、ハンドルネーム・アバター・Xリンクが見える
4. Xリンクをタップすると、Xプロフィールへ遷移できる
5. 公開プロフィール閲覧が端末の閲覧履歴として自動保存され、上限100件で古いものが削除される
6. お気に入りを保存/解除でき、端末に状態が残る
7. ログイン済み閲覧者はお気に入りがクラウドにも保存され、論理削除で解除できる